<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Pro v5</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --green:#2ecc71; --green-dark:#27ae60; --bg:#f4f7f6; --card:#ffffff; --radius:12px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:sans-serif;background:var(--bg); display:flex; flex-direction:column; height:100vh;}
    header{background:var(--green); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    main{display:flex; flex:1; overflow:hidden; gap:15px; padding:15px;}
    .sidebar{width:300px; background:white; border-radius:var(--radius); display:flex; flex-direction:column; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .content{flex:1; display:flex; flex-direction:column; gap:15px;}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; overflow-y:auto;}
    .cat-item{padding:12px; border:1px solid #eee; margin-bottom:8px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; background:#fff;}
    .cat-item:hover{border-color:var(--green); background:#f9fff9;}
    .card{background:white; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:8px;}
    .card img{width:100%; height:130px; object-fit:cover; border-radius:8px; background:#f0f0f0;}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100;}
    .modal-content{background:white; padding:25px; border-radius:15px; width:95%; max-width:450px; box-shadow:0 10px 25px rgba(0,0,0,0.2);}
    .btn{padding:10px 15px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; transition:0.2s;}
    .btn-main{background:var(--green); color:white;}
    .btn-alt{background:#34495e; color:white;}
    .btn-edit{background:#f1c40f; color:white; font-size:11px;}
    .btn-del{background:#e74c3c; color:white; font-size:11px;}
    input, select{ width:100%; padding:12px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px; }
    .search-box { padding:10px; border-radius:8px; border:1px solid #ddd; width:100%; max-width:250px; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <span style="font-size:24px;">ðŸ“¦</span>
    <strong>Inventario Pro v5</strong>
  </div>
  <div style="display:flex; gap:8px;">
    <button class="btn btn-alt" onclick="exportarExcelEstiloGrafico()">ðŸ“Š Excel Pro</button>
    <button class="btn btn-alt" onclick="respaldarWhatsApp()">ðŸ“² Copiar</button>
    <button class="btn btn-alt" onclick="cargarDesdeWhatsApp()">ðŸ“¥ Cargar</button>
  </div>
</header>

<main>
  <aside class="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0; color:#34495e;">CategorÃ­as</h3>
      <button class="btn btn-main" onclick="abrirModalCat()">+</button>
    </div>
    <div id="catsList" style="flex:1; overflow-y:auto; padding-right:5px;"></div>
  </aside>

  <section class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2 id="current-title" style="margin:0; color:#2c3e50;">Inicio</h2>
      <div style="display:flex; gap:10px; flex:1; justify-content:flex-end; align-items:center;">
        <input type="text" id="busqueda" class="search-box" placeholder="ðŸ” Buscar..." oninput="renderProds()">
        <button class="btn btn-main" onclick="abrirModalProd()">+ Producto</button>
      </div>
    </div>
    <div id="cardsGrid" class="grid"></div>
  </section>
</main>

<div id="modalCat" class="modal"><div class="modal-content">
  <h3 id="catModalTitle">Nueva CategorÃ­a</h3>
  <input type="text" id="newCatName" placeholder="Ej: ORGANIZADORES">
  <div style="display:flex; gap:10px; justify-content:flex-end;">
    <button class="btn" onclick="cerrarModales()">Cancelar</button>
    <button class="btn btn-main" onclick="guardarCategoria()">Guardar</button>
  </div>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
  <h3 id="prodModalTitle">Datos del Producto</h3>
  <input type="hidden" id="editProdId">
  <input type="text" id="pNombre" placeholder="Nombre (ej. 1. PULIDO)">
  <div style="display:flex; gap:10px;">
    <div style="flex:1"><label style="font-size:12px; color:gray;">Paquetes</label><input type="number" id="pStock" value="1"></div>
    <div style="flex:1"><label style="font-size:12px; color:gray;">Unid x Paquete</label><input type="number" id="pUnidades" value="1"></div>
  </div>
  <label style="font-size:12px; color:gray;">Imagen (compresiÃ³n auto)</label>
  <input type="file" id="pFoto" accept="image/*">
  <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
    <button class="btn" onclick="cerrarModales()">Cancelar</button>
    <button class="btn btn-main" onclick="guardarProducto()">Guardar</button>
  </div>
</div></div>

<script>
  let store = JSON.parse(localStorage.getItem('inv_v5')) || { categories: [], products: [] };
  let currentParentId = null;
  const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

  function save() { localStorage.setItem('inv_v5', JSON.stringify(store)); render(); }

  async function comprimirImagen(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const MAX_WIDTH = 400;
          const scale = MAX_WIDTH / img.width;
          canvas.width = MAX_WIDTH;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.7));
        };
      };
    });
  }

  function render() {
    renderCats();
    renderProds();
    const actual = store.categories.find(c => c.id === currentParentId);
    document.getElementById('current-title').innerText = actual ? actual.name : "Inicio";
  }

  function renderCats() {
    const list = document.getElementById('catsList');
    list.innerHTML = currentParentId ? `<div class="cat-item" onclick="subirNivel()" style="background:#eee;"><b>â¬… Volver</b></div>` : "";
    store.categories.filter(c => c.parentId === currentParentId).forEach(cat => {
      list.innerHTML += `
        <div class="cat-item">
          <span onclick="entrarCat('${cat.id}')" style="flex:1; font-weight:500;">${cat.name}</span>
          <button class="btn-edit" onclick="editarCat('${cat.id}')" style="margin-right:5px;">âœŽ</button>
          <button class="btn-del" onclick="borrarCat('${cat.id}')">ðŸ—‘</button>
        </div>`;
    });
  }

  function renderProds() {
    const grid = document.getElementById('cardsGrid');
    const term = document.getElementById('busqueda').value.toLowerCase();
    grid.innerHTML = "";
    const prods = store.products.filter(p => (term ? true : p.catId === currentParentId) && p.name.toLowerCase().includes(term));
    prods.forEach(p => {
      const total = p.stock * (p.unidades || 1);
      grid.innerHTML += `
        <div class="card">
          <img src="${p.foto || 'https://via.placeholder.com/150'}">
          <h4 style="margin:5px 0;">${p.name}</h4>
          <div style="font-size:12px; color:#555; background:#f9f9f9; padding:5px; border-radius:5px;">
            Total: <b>${total} unidades</b>
          </div>
          <div style="display:flex; gap:5px; margin-top:auto;">
            <button class="btn btn-edit" style="flex:1" onclick="abrirEditarProd('${p.id}')">Editar</button>
            <button class="btn btn-del" style="flex:1" onclick="borrarProd('${p.id}')">Borrar</button>
          </div>
        </div>`;
    });
  }

  function entrarCat(id) { currentParentId = id; render(); }
  function subirNivel() { 
    const c = store.categories.find(x => x.id === currentParentId);
    currentParentId = c ? c.parentId : null;
    render();
  }

  function abrirModalCat() { document.getElementById('modalCat').style.display='flex'; }
  function abrirModalProd() { 
    document.getElementById('editProdId').value = "";
    document.getElementById('pNombre').value = "";
    document.getElementById('modalProd').style.display='flex'; 
  }

  function abrirEditarProd(id) {
    const p = store.products.find(x => x.id === id);
    document.getElementById('editProdId').value = p.id;
    document.getElementById('pNombre').value = p.name;
    document.getElementById('pStock').value = p.stock;
    document.getElementById('pUnidades').value = p.unidades;
    document.getElementById('modalProd').style.display='flex';
  }

  function cerrarModales() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }

  function guardarCategoria() {
    const name = document.getElementById('newCatName').value.toUpperCase();
    if(name) store.categories.push({id: uid(), name, parentId: currentParentId});
    cerrarModales(); save();
  }

  function editarCat(id) {
    const cat = store.categories.find(c => c.id === id);
    const nuevo = prompt("Editar nombre:", cat.name);
    if(nuevo) { cat.name = nuevo.toUpperCase(); save(); }
  }

  async function guardarProducto() {
    const id = document.getElementById('editProdId').value;
    const name = document.getElementById('pNombre').value.toUpperCase();
    const stock = parseInt(document.getElementById('pStock').value);
    const unidades = parseInt(document.getElementById('pUnidades').value);
    const file = document.getElementById('pFoto').files[0];
    let foto = "";
    if(file) foto = await comprimirImagen(file);
    if(id) {
      const p = store.products.find(x => x.id === id);
      p.name = name; p.stock = stock; p.unidades = unidades;
      if(foto) p.foto = foto;
    } else {
      store.products.push({id: uid(), name, stock, unidades, foto, catId: currentParentId});
    }
    cerrarModales(); save();
  }

  function borrarCat(id) { if(confirm("Â¿Borrar?")) { store.categories = store.categories.filter(c=>c.id!==id); save(); } }
  function borrarProd(id) { if(confirm("Â¿Borrar?")) { store.products = store.products.filter(p=>p.id!==id); save(); } }

  function respaldarWhatsApp() {
    const data = btoa(unescape(encodeURIComponent(JSON.stringify(store))));
    navigator.clipboard.writeText(data);
    alert("Copiado para WhatsApp");
  }

  function cargarDesdeWhatsApp() {
    const code = prompt("Pega el cÃ³digo:");
    if(code) {
      try {
        store = JSON.parse(decodeURIComponent(escape(atob(code))));
        save(); location.reload();
      } catch(e) { alert("Error"); }
    }
  }

  // --- EXPORTACIÃ“N CON FORMATO GRÃFICO ---
  function exportarExcelEstiloGrafico() {
    const wb = XLSX.utils.book_new();
    const raices = store.categories.filter(c => c.parentId === null);

    raices.forEach(raiz => {
      let rows = [];
      // Fila 1: CategorÃ­a Principal (Verde)
      rows.push([raiz.name, ""]); 
      rows.push(["", ""]); // Espacio

      // Buscar subcategorÃ­as e hijos
      let buscarEnRama = (idPadre, nivel) => {
        const subcats = store.categories.filter(c => c.parentId === idPadre);
        
        // Productos directos de esta categorÃ­a
        const prods = store.products.filter(p => p.catId === idPadre);
        if(prods.length > 0) {
          const nombrePadre = store.categories.find(c => c.id === idPadre).name;
          rows.push([nombrePadre, ""]); // SubtÃ­tulo verde
          rows.push(["NOMBRE PRODUCTO", "UNIDADES"]); // Encabezado tabla
          prods.forEach(p => {
            rows.push([p.name, p.stock * (p.unidades || 1)]);
          });
          rows.push(["", ""]); // Espacio tras tabla
        }

        subcats.forEach(s => buscarEnRama(s.id, nivel + 1));
      };

      buscarEnRama(raiz.id, 0);

      const ws = XLSX.utils.aoa_to_sheet(rows);
      
      // Ajuste de ancho de columnas
      ws['!cols'] = [{wch: 40}, {wch: 15}];

      XLSX.utils.book_append_sheet(wb, ws, raiz.name.substring(0,30));
    });

    XLSX.writeFile(wb, "Inventario_Estilo_Manual.xlsx");
  }

  render();
</script>
</body>
</html>
