<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Cloud v10 - Drive</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDRKyPBXDcYwoiPU1dPLde58a1-_Z_kvYI",
      authDomain: "mi-inventario-21b8b.firebaseapp.com",
      projectId: "mi-inventario-21b8b",
      storageBucket: "mi-inventario-21b8b.firebasestorage.app",
      messagingSenderId: "1063315770419",
      appId: "1:1063315770419:web:40a8dc3efe080a6382e746"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let store = { categories: [], products: [] };
    let currentParentId = null;

    // Tu URL de Apps Script que me pasaste
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyr5A8pTM3d73sK8tWljVTnXFnDN0hOhK6NMRs8h_qMGscjuhUmggY8F_anFsNDhhYJ/exec";

    onSnapshot(collection(db, "categories"), (snap) => { store.categories = snap.docs.map(d => ({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "products"), (snap) => { store.products = snap.docs.map(d => ({id:d.id, ...d.data()})); render(); });

    window.sincronizarDrive = async () => {
      const btn = document.getElementById('btnSync');
      btn.innerText = "‚è≥ Sincronizando...";
      btn.disabled = true;

      let exportData = [];
      const raices = store.categories.filter(c => c.parentId === null);

      raices.forEach(raiz => {
        const buscarRecursivo = (catId, mainCatName) => {
          const prods = store.products.filter(p => p.catId === catId);
          const catActual = store.categories.find(c => c.id === catId);
          if(prods.length > 0) {
            prods.forEach(p => {
              exportData.push({
                mainCat: mainCatName,
                subCat: catActual.name,
                name: p.name,
                desc: p.desc || "",
                unidades: p.unidades
              });
            });
          }
          store.categories.filter(c => c.parentId === catId).forEach(sub => buscarRecursivo(sub.id, mainCatName));
        };
        buscarRecursivo(raiz.id, raiz.name);
      });

      try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(exportData) });
        alert("‚úÖ ¬°Sincronizado! Revisa tu Google Sheets.");
      } catch (e) {
        alert("Error al conectar con Drive");
      } finally {
        btn.innerText = "üîÑ Sincronizar Drive";
        btn.disabled = false;
      }
    };

    window.entrarCat = (id) => { currentParentId = id; render(); if(window.innerWidth < 768) toggleSidebar(); };
    window.subirNivel = () => { const c = store.categories.find(x => x.id === currentParentId); currentParentId = c ? c.parentId : null; render(); };
    window.guardarCategoria = async () => {
      const name = document.getElementById('newCatName').value.toUpperCase();
      const id = document.getElementById('editCatId').value || Date.now().toString(36);
      if(!name) return;
      await setDoc(doc(db, "categories", id), { name, parentId: currentParentId }, { merge: true });
      cerrarModales();
    };
    window.abrirEditarCat = (id, name) => { document.getElementById('editCatId').value = id; document.getElementById('newCatName').value = name; document.getElementById('modalCat').style.display='flex'; };
    window.guardarProducto = async () => {
      const id = document.getElementById('editProdId').value || Date.now().toString(36);
      const name = document.getElementById('pNombre').value.toUpperCase();
      const unidades = parseInt(document.getElementById('pUnidades').value) || 0;
      const desc = document.getElementById('pDesc').value.toUpperCase();
      const file = document.getElementById('pFoto').files[0];
      let pData = { name, unidades, desc, catId: currentParentId };
      if(file) pData.foto = await comprimirImagen(file);
      await setDoc(doc(db, "products", id), pData, { merge: true });
      cerrarModales();
    };
    window.borrarCat = async (id) => { if(confirm("¬øBorrar categor√≠a?")) await deleteDoc(doc(db, "categories", id)); };
    window.borrarProd = async (id) => { if(confirm("¬øBorrar producto?")) await deleteDoc(doc(db, "products", id)); };
    window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); };
    window.cerrarModales = () => { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); };

    function render() {
      const catList = document.getElementById('catsList');
      const prodGrid = document.getElementById('cardsGrid');
      const actual = store.categories.find(c => c.id === currentParentId);
      document.getElementById('current-title').innerText = actual ? actual.name : "Inicio";
      catList.innerHTML = currentParentId ? `<div class="cat-item" onclick="subirNivel()"><b>‚¨Ö Volver</b></div>` : "";
      store.categories.filter(c => c.parentId === currentParentId).forEach(cat => {
        catList.innerHTML += `<div class="cat-item"><span onclick="entrarCat('${cat.id}')" style="flex:1">${cat.name}</span><div style="display:flex; gap:4px;"><button class="btn-edit" onclick="abrirEditarCat('${cat.id}', '${cat.name}')">‚úé</button><button class="btn-del" onclick="borrarCat('${cat.id}')">üóë</button></div></div>`;
      });
      prodGrid.innerHTML = "";
      store.products.filter(p => p.catId === currentParentId).forEach(p => {
        prodGrid.innerHTML += `<div class="card"><img src="${p.foto || 'https://via.placeholder.com/150'}"><h4>${p.name}</h4><p style="font-size:11px; color:#666">${p.desc || ''}</p><div class="unidades-badge"><b>${p.unidades} UNIDADES</b></div><div style="display:flex; gap:5px; margin-top:auto;"><button class="btn-edit" style="flex:1" onclick="abrirEditarProd('${p.id}')">Editar</button><button class="btn-del" style="flex:1" onclick="borrarProd('${p.id}')">Borrar</button></div></div>`;
      });
    }

    async function comprimirImagen(file) {
      return new Promise((res) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = (e) => { const i = new Image(); i.src = e.target.result; i.onload = () => {
          const c = document.createElement('canvas'); c.width = 300; c.height = (i.height * 300) / i.width;
          c.getContext('2d').drawImage(i, 0, 0, c.width, c.height); res(c.toDataURL('image/jpeg', 0.5));
        };};
      });
    }

    window.abrirEditarProd = (id) => {
      const p = store.products.find(x => x.id === id);
      document.getElementById('editProdId').value = p.id;
      document.getElementById('pNombre').value = p.name;
      document.getElementById('pUnidades').value = p.unidades;
      document.getElementById('pDesc').value = p.desc || "";
      document.getElementById('modalProd').style.display='flex';
    };
  </script>

  <style>
    :root{ --green:#2ecc71; --dark:#27ae60; --bg:#f4f7f6; --radius:12px; }
    body{ margin:0; font-family:sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; overflow:hidden;}
    header{ background:var(--green); color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; z-index:10; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    main{ display:flex; flex:1; overflow:hidden; position:relative; }
    .sidebar{ width:280px; background:white; padding:15px; display:flex; flex-direction:column; box-shadow:2px 0 5px rgba(0,0,0,0.05); transition: 0.3s; z-index:5; }
    .content{ flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
    @media (max-width: 768px) { .sidebar { position: absolute; left: -280px; height: 100%; } .sidebar.active { left: 0; } .menu-toggle { display: block !important; } }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; }
    .cat-item{ padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px; cursor:pointer; display:flex; align-items:center; background:white; transition:0.2s; }
    .cat-item:hover{ background:#f9f9f9; }
    .card{ background:white; padding:10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); display:flex; flex-direction:column; gap:5px; border:1px solid #eee; }
    .card img{ width:100%; height:110px; object-fit:cover; border-radius:8px; background:#eee; }
    .unidades-badge{ background:#e8f5e9; color:var(--dark); padding:5px; border-radius:5px; text-align:center; font-size:12px; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(2px); }
    .modal-content{ background:white; padding:20px; border-radius:15px; width:90%; max-width:400px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    .btn-main{ background:var(--green); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-sync{ background:#34495e; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13px; }
    .btn-del{ background:#ff7675; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:12px;}
    .btn-edit{ background:#fdcb6e; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; font-size:12px;}
    input, textarea{ width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; font-size:14px; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <button class="menu-toggle" style="display:none; background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:5px;" onclick="toggleSidebar()">‚ò∞</button>
    <strong style="font-size:1.1rem;">üì¶ Mi Inventario</strong>
  </div>
  <button id="btnSync" class="btn-sync" onclick="sincronizarDrive()">üîÑ Sincronizar Drive</button>
</header>

<main>
  <aside class="sidebar" id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0; color:#444">Categor√≠as</h3>
      <button class="btn-main" style="padding:5px 12px" onclick="document.getElementById('editCatId').value=''; document.getElementById('newCatName').value=''; document.getElementById('modalCat').style.display='flex'">+</button>
    </div>
    <div id="catsList" style="overflow-y:auto"></div>
  </aside>

  <section class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2 id="current-title" style="margin:0; font-size:1.3rem; color:#2d3436">Inicio</h2>
      <button class="btn-main" onclick="document.getElementById('modalProd').style.display='flex'; document.getElementById('editProdId').value=''; document.getElementById('pNombre').value='';">+ Producto</button>
    </div>
    <div id="cardsGrid" class="grid"></div>
  </section>
</main>

<div id="modalCat" class="modal"><div class="modal-content">
  <h3 style="margin-top:0">üìÅ Categor√≠a</h3>
  <input type="hidden" id="editCatId">
  <input type="text" id="newCatName" placeholder="EJ: CAJONES, HERRAMIENTAS...">
  <button class="btn-main" style="width:100%" onclick="guardarCategoria()">Guardar</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px; color:#636e72; cursor:pointer">Cancelar</button>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
  <h3 style="margin-top:0">üì¶ Datos del Producto</h3>
  <input type="hidden" id="editProdId">
  <input type="text" id="pNombre" placeholder="NOMBRE DEL PRODUCTO">
  <input type="number" id="pUnidades" placeholder="CANTIDAD" value="1">
  <textarea id="pDesc" placeholder="DESCRIPCI√ìN (OPCIONAL)" rows="3"></textarea>
  <label style="font-size:12px; color:#636e72">Foto del producto:</label>
  <input type="file" id="pFoto" accept="image/*" style="border:none; padding:5px 0">
  <button class="btn-main" style="width:100%" onclick="guardarProducto()">Guardar Producto</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px; color:#636e72; cursor:pointer">Cancelar</button>
</div></div>

</body>
</html>
