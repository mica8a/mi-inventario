<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Cloud v9</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ConfiguraciÃ³n que me pasaste
    const firebaseConfig = {
      apiKey: "AIzaSyDRKyPBXDcYwoiPU1dPLde58a1-_Z_kvYI",
      authDomain: "mi-inventario-21b8b.firebaseapp.com",
      projectId: "mi-inventario-21b8b",
      storageBucket: "mi-inventario-21b8b.firebasestorage.app",
      messagingSenderId: "1063315770419",
      appId: "1:1063315770419:web:40a8dc3efe080a6382e746"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- VARIABLES DE ESTADO ---
    let store = { categories: [], products: [] };
    let currentParentId = null;

    // --- SINCRONIZACIÃ“N EN TIEMPO REAL ---
    // Escuchar CategorÃ­as
    onSnapshot(collection(db, "categories"), (snapshot) => {
      store.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render();
    });

    // Escuchar Productos
    onSnapshot(collection(db, "products"), (snapshot) => {
      store.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render();
    });

    // --- FUNCIONES GLOBALIZADAS ---
    window.entrarCat = (id) => { currentParentId = id; render(); };
    window.subirNivel = () => {
      const c = store.categories.find(x => x.id === currentParentId);
      currentParentId = c ? c.parentId : null;
      render();
    };

    window.guardarCategoria = async () => {
      const name = document.getElementById('newCatName').value.toUpperCase();
      if(!name) return;
      const id = Date.now().toString(36);
      await setDoc(doc(db, "categories", id), { name, parentId: currentParentId });
      cerrarModales();
    };

    window.guardarProducto = async () => {
      const id = document.getElementById('editProdId').value || Date.now().toString(36);
      const name = document.getElementById('pNombre').value.toUpperCase();
      const unidades = parseInt(document.getElementById('pUnidades').value) || 0;
      const desc = document.getElementById('pDesc').value.toUpperCase();
      const file = document.getElementById('pFoto').files[0];
      
      let pData = { name, unidades, desc, catId: currentParentId };
      
      if(file) {
        pData.foto = await comprimirImagen(file);
      } else if (document.getElementById('editProdId').value) {
        const exist = store.products.find(p => p.id === id);
        if(exist.foto) pData.foto = exist.foto;
      }

      await setDoc(doc(db, "products", id), pData);
      cerrarModales();
    };

    window.borrarCat = async (id) => { if(confirm("Â¿Borrar categorÃ­a?")) await deleteDoc(doc(db, "categories", id)); };
    window.borrarProd = async (id) => { if(confirm("Â¿Borrar producto?")) await deleteDoc(doc(db, "products", id)); };

    // --- RENDERIZADO ---
    function render() {
      const catList = document.getElementById('catsList');
      const prodGrid = document.getElementById('cardsGrid');
      const title = document.getElementById('current-title');
      
      // TÃ­tulo
      const actual = store.categories.find(c => c.id === currentParentId);
      title.innerText = actual ? actual.name : "Inicio";

      // CategorÃ­as
      catList.innerHTML = currentParentId ? `<div class="cat-item" onclick="subirNivel()"><b>â¬… Volver</b></div>` : "";
      store.categories.filter(c => c.parentId === currentParentId).forEach(cat => {
        catList.innerHTML += `
          <div class="cat-item">
            <span onclick="entrarCat('${cat.id}')" style="flex:1">${cat.name}</span>
            <button class="btn-del" onclick="borrarCat('${cat.id}')">ðŸ—‘</button>
          </div>`;
      });

      // Productos
      prodGrid.innerHTML = "";
      store.products.filter(p => p.catId === currentParentId).forEach(p => {
        prodGrid.innerHTML += `
          <div class="card">
            <img src="${p.foto || 'https://via.placeholder.com/150'}">
            <h4>${p.name}</h4>
            <p style="font-size:11px; color:#666">${p.desc || ''}</p>
            <div class="unidades-badge"><b>${p.unidades} UNIDADES</b></div>
            <div style="display:flex; gap:5px; margin-top:auto;">
              <button class="btn-edit" style="flex:1" onclick="abrirEditar('${p.id}')">âœŽ</button>
              <button class="btn-del" style="flex:1" onclick="borrarProd('${p.id}')">ðŸ—‘</button>
            </div>
          </div>`;
      });
    }

    // Funciones auxiliares
    async function comprimirImagen(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 300; canvas.height = (img.height * 300) / img.width;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.5));
          };
        };
      });
    }

    window.exportarExcelV9 = () => {
      const wb = XLSX.utils.book_new();
      const raices = store.categories.filter(c => c.parentId === null);
      raices.forEach(raiz => {
        let rows = [[raiz.name], [""]];
        const buscar = (id) => {
          const prods = store.products.filter(p => p.catId === id);
          if(prods.length > 0) {
            rows.push([store.categories.find(c=>c.id===id).name]);
            rows.push(["PRODUCTO", "DESCRIPCIÃ“N", "UNIDADES"]);
            prods.forEach(p => rows.push([p.name, p.desc || "", p.unidades]));
            rows.push([""]);
          }
          store.categories.filter(c=>c.parentId===id).forEach(s => buscar(s.id));
        };
        buscar(raiz.id);
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, raiz.name.substring(0,30));
      });
      XLSX.writeFile(wb, "Inventario_Sincronizado.xlsx");
    };

    window.abrirEditar = (id) => {
      const p = store.products.find(x => x.id === id);
      document.getElementById('editProdId').value = p.id;
      document.getElementById('pNombre').value = p.name;
      document.getElementById('pUnidades').value = p.unidades;
      document.getElementById('pDesc').value = p.desc || "";
      document.getElementById('modalProd').style.display='flex';
    };
  </script>

  <style>
    :root{ --green:#2ecc71; --bg:#f4f7f6; --radius:12px; }
    body{ margin:0; font-family:sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; }
    header{ background:var(--green); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    main{ display:flex; flex:1; overflow:hidden; padding:15px; gap:15px; }
    .sidebar{ width:280px; background:white; border-radius:var(--radius); padding:15px; display:flex; flex-direction:column; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .content{ flex:1; display:flex; flex-direction:column; gap:15px; overflow-y:auto; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; }
    .cat-item{ padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; background:white; }
    .card{ background:white; padding:10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); display:flex; flex-direction:column; gap:5px; }
    .card img{ width:100%; height:120px; object-fit:cover; border-radius:8px; }
    .unidades-badge{ background:#f0fcf4; padding:5px; border-radius:5px; text-align:center; font-size:13px; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:100; }
    .modal-content{ background:white; padding:20px; border-radius:15px; width:90%; max-width:400px; }
    .btn-main{ background:var(--green); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-del{ background:#e74c3c; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; }
    .btn-edit{ background:#f1c40f; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer; }
    input, textarea{ width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; }
  </style>
</head>
<body>

<header>
  <strong>ðŸ“¦ Inventario Cloud v9</strong>
  <button class="btn-main" style="background:#34495e" onclick="exportarExcelV9()">ðŸ“Š Descargar Excel</button>
</header>

<main>
  <aside class="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3 style="margin:0">CategorÃ­as</h3>
      <button class="btn-main" onclick="document.getElementById('modalCat').style.display='flex'">+</button>
    </div>
    <div id="catsList" style="overflow-y:auto"></div>
  </aside>

  <section class="content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 id="current-title" style="margin:0">Inicio</h2>
      <button class="btn-main" onclick="document.getElementById('modalProd').style.display='flex'; document.getElementById('editProdId').value='';">+ Producto</button>
    </div>
    <div id="cardsGrid" class="grid"></div>
  </section>
</main>

<div id="modalCat" class="modal"><div class="modal-content">
  <h3>Nueva CategorÃ­a</h3>
  <input type="text" id="newCatName" placeholder="NOMBRE DE CATEGORÃA">
  <button class="btn-main" style="width:100%" onclick="guardarCategoria()">Guardar</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer">Cancelar</button>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
  <h3>Datos del Producto</h3>
  <input type="hidden" id="editProdId">
  <input type="text" id="pNombre" placeholder="NOMBRE">
  <input type="number" id="pUnidades" placeholder="UNIDADES" value="1">
  <textarea id="pDesc" placeholder="DESCRIPCIÃ“N"></textarea>
  <input type="file" id="pFoto" accept="image/*">
  <button class="btn-main" style="width:100%" onclick="guardarProducto()">Guardar Producto</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer">Cancelar</button>
</div></div>

<script>
  function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
</script>

</body>
</html>
