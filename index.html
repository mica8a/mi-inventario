<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Pro v11.2</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDRKyPBXDcYwoiPU1dPLde58a1-_Z_kvYI",
      authDomain: "mi-inventario-21b8b.firebaseapp.com",
      projectId: "mi-inventario-21b8b",
      storageBucket: "mi-inventario-21b8b.firebasestorage.app",
      messagingSenderId: "1063315770419",
      appId: "1:1063315770419:web:40a8dc3efe080a6382e746"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let store = { categories: [], products: [] };
    let currentParentId = null;
    let searchTerm = "";

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyr5A8pTM3d73sK8tWljVTnXFnDN0hOhK6NMRs8h_qMGscjuhUmggY8F_anFsNDhhYJ/exec";

    onSnapshot(collection(db, "categories"), (snap) => { store.categories = snap.docs.map(d => ({id:d.id, ...d.data()})); render(); });
    onSnapshot(collection(db, "products"), (snap) => { store.products = snap.docs.map(d => ({id:d.id, ...d.data()})); render(); });

    window.filtrar = (e) => { searchTerm = e.target.value.toUpperCase(); render(); };

    window.sincronizarDrive = async () => {
      const btn = document.getElementById('btnSync');
      btn.innerText = "‚è≥..."; btn.disabled = true;
      let exportData = [];
      const raices = store.categories.filter(c => c.parentId === null);
      raices.forEach(raiz => {
        const buscar = (catId, main) => {
          const prods = store.products.filter(p => p.catId === catId);
          const cat = store.categories.find(c => c.id === catId);
          if(prods.length > 0) prods.forEach(p => exportData.push({mainCat: main, subCat: cat.name, name: p.name, desc: p.desc || "", unidades: p.unidades}));
          store.categories.filter(c => c.parentId === catId).forEach(sub => buscar(sub.id, main));
        };
        buscar(raiz.id, raiz.name);
      });
      try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(exportData) }); alert("‚úÖ Sincronizado"); } 
      catch (e) { alert("Error"); } finally { btn.innerText = "üîÑ Drive"; btn.disabled = false; }
    };

    window.entrarCat = (id) => { currentParentId = id; searchTerm = ""; document.getElementById('searchInp').value = ""; render(); if(window.innerWidth < 768) toggleSidebar(); };
    window.subirNivel = () => { const c = store.categories.find(x => x.id === currentParentId); currentParentId = c ? c.parentId : null; render(); };
    
    window.guardarCategoria = async () => {
      const name = document.getElementById('newCatName').value.toUpperCase();
      const id = document.getElementById('editCatId').value || Date.now().toString(36);
      if(!name) return;
      await setDoc(doc(db, "categories", id), { name, parentId: currentParentId }, { merge: true });
      cerrarModales();
    };

    window.guardarProducto = async () => {
      const id = document.getElementById('editProdId').value || Date.now().toString(36);
      const name = document.getElementById('pNombre').value.toUpperCase();
      const unidades = parseInt(document.getElementById('pUnidades').value) || 0;
      const desc = document.getElementById('pDesc').value.toUpperCase();
      const file = document.getElementById('pFoto').files[0];
      let pData = { name, unidades, desc, catId: currentParentId };
      if(file) pData.foto = await comprimirImagen(file);
      await setDoc(doc(db, "products", id), pData, { merge: true });
      cerrarModales();
    };

    // FUNCI√ìN PARA VER DETALLE
    window.verDetalle = (id) => {
      const p = store.products.find(x => x.id === id);
      document.getElementById('detImg').src = p.foto || 'https://via.placeholder.com/300';
      document.getElementById('detNombre').innerText = p.name;
      document.getElementById('detDesc').innerText = p.desc || "Sin descripci√≥n";
      document.getElementById('detQty').innerText = p.unidades + " UNIDADES";
      document.getElementById('modalDetalle').style.display = 'flex';
    };

    window.borrarCat = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, "categories", id)); };
    window.borrarProd = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, "products", id)); };
    window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); };
    window.cerrarModales = () => { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); };

    function render() {
      const catList = document.getElementById('catsList');
      const prodGrid = document.getElementById('cardsGrid');
      const actual = store.categories.find(c => c.id === currentParentId);
      document.getElementById('current-title').innerText = searchTerm ? "Resultados" : (actual ? actual.name : "Inicio");

      catList.innerHTML = currentParentId && !searchTerm ? `<div class="cat-item" onclick="subirNivel()"><b>‚¨Ö Volver</b></div>` : "";
      if(!searchTerm) {
        store.categories.filter(c => c.parentId === currentParentId).forEach(cat => {
          catList.innerHTML += `<div class="cat-item"><span onclick="entrarCat('${cat.id}')" style="flex:1">${cat.name}</span><div style="display:flex; gap:4px;"><button class="btn-edit-mini" onclick="abrirEditarCat('${cat.id}', '${cat.name}')">‚úé</button><button class="btn-del-mini" onclick="borrarCat('${cat.id}')">üóë</button></div></div>`;
        });
      }

      prodGrid.innerHTML = "";
      const filtered = store.products.filter(p => {
        const matchesSearch = p.name.includes(searchTerm) || (p.desc && p.desc.includes(searchTerm));
        return searchTerm ? matchesSearch : (p.catId === currentParentId && matchesSearch);
      });

      filtered.forEach(p => {
        prodGrid.innerHTML += `
          <div class="prod-row">
            <div style="display:flex; align-items:center; flex:1; gap:10px;" onclick="verDetalle('${p.id}')">
                <img src="${p.foto || 'https://via.placeholder.com/50'}" class="prod-img">
                <div class="prod-info">
                  <div class="prod-name">${p.name}</div>
                  <div class="prod-desc">${p.desc || ''}</div>
                </div>
            </div>
            <div class="prod-qty"><b>${p.unidades}</b><br><small>UN</small></div>
            <div class="prod-btns">
              <button class="btn-edit-mini" onclick="abrirEditarProd('${p.id}')">‚úé</button>
              <button class="btn-del-mini" onclick="borrarProd('${p.id}')">üóë</button>
            </div>
          </div>`;
      });
    }

    async function comprimirImagen(file) {
      return new Promise((res) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = (e) => { const i = new Image(); i.src = e.target.result; i.onload = () => {
          const c = document.createElement('canvas'); c.width = 400; c.height = (i.height * 400) / i.width;
          c.getContext('2d').drawImage(i, 0, 0, c.width, c.height); res(c.toDataURL('image/jpeg', 0.6));
        };};
      });
    }

    window.abrirEditarProd = (id) => {
      const p = store.products.find(x => x.id === id);
      document.getElementById('editProdId').value = p.id;
      document.getElementById('pNombre').value = p.name;
      document.getElementById('pUnidades').value = p.unidades;
      document.getElementById('pDesc').value = p.desc || "";
      document.getElementById('modalProd').style.display='flex';
    };

    window.abrirEditarCat = (id, name) => {
      document.getElementById('editCatId').value = id;
      document.getElementById('newCatName').value = name;
      document.getElementById('modalCat').style.display='flex';
    };
  </script>

  <style>
    :root{ --green:#2ecc71; --bg:#f4f7f6; }
    body{ margin:0; font-family:sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; overflow:hidden;}
    header{ background:var(--green); color:white; padding:8px 15px; display:flex; flex-direction:column; gap:8px; z-index:10; }
    .top-bar{ display:flex; justify-content:space-between; align-items:center; }
    .search-box input{ width:100%; padding:8px 12px; border-radius:20px; border:none; outline:none; font-size:14px; box-sizing:border-box; }
    
    main{ display:flex; flex:1; overflow:hidden; position:relative; }
    .sidebar{ width:260px; background:white; padding:10px; display:flex; flex-direction:column; box-shadow:2px 0 5px rgba(0,0,0,0.05); transition: 0.3s; z-index:5; }
    .content{ flex:1; display:flex; flex-direction:column; padding:10px; overflow-y:auto; }
    
    @media (max-width: 768px) { .sidebar { position: absolute; left: -260px; height: 100%; } .sidebar.active { left: 0; } }

    .cat-item{ padding:10px; border-bottom:1px solid #eee; display:flex; align-items:center; cursor:pointer; font-size:14px; }
    .prod-row{ background:white; display:flex; align-items:center; padding:8px; border-radius:8px; margin-bottom:6px; gap:10px; border:1px solid #eee; cursor:pointer; }
    .prod-img{ width:45px; height:45px; border-radius:6px; object-fit:cover; background:#eee; }
    .prod-info{ flex:1; overflow:hidden; }
    .prod-name{ font-weight:bold; font-size:13px; color:#333; }
    .prod-desc{ font-size:11px; color:#777; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .prod-qty{ text-align:center; min-width:40px; color:var(--green); }
    .prod-btns{ display:flex; flex-direction:column; gap:4px; }

    .btn-edit-mini{ background:#fdcb6e; border:none; color:white; padding:4px 8px; border-radius:4px; }
    .btn-del-mini{ background:#ff7675; border:none; color:white; padding:4px 8px; border-radius:4px; }
    .btn-main{ background:var(--green); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold; }
    
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:100; padding:15px; }
    .modal-content{ background:white; padding:20px; border-radius:15px; width:100%; max-width:400px; box-sizing:border-box; max-height: 90vh; overflow-y: auto; }
    
    /* ESTILO MODAL DETALLE */
    #detImg { width: 100%; border-radius: 10px; margin-bottom: 15px; max-height: 300px; object-fit: contain; background: #f9f9f9; }
    #detNombre { margin: 0; font-size: 1.4rem; color: #333; }
    #detQty { display: inline-block; background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 5px; font-weight: bold; margin: 10px 0; }
    #detDesc { color: #666; line-height: 1.4; font-size: 15px; }

    input[type="text"], input[type="number"], textarea{ width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; }
  </style>
</head>
<body>

<header>
  <div class="top-bar">
    <div style="display:flex; align-items:center; gap:8px;">
      <button onclick="toggleSidebar()" style="background:none; border:1px solid white; color:white; border-radius:5px; padding:4px 8px;">‚ò∞</button>
      <strong>Inventario Pro</strong>
    </div>
    <button id="btnSync" class="btn-main" style="background:#34495e; font-size:12px; padding:5px 10px;" onclick="sincronizarDrive()">üîÑ Drive</button>
  </div>
  <div class="search-box">
    <input type="text" id="searchInp" placeholder="üîç Buscar productos..." oninput="filtrar(event)">
  </div>
</header>

<main>
  <aside class="sidebar" id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3 style="margin:0">Categor√≠as</h3>
      <button class="btn-main" style="padding:4px 10px" onclick="document.getElementById('editCatId').value=''; document.getElementById('newCatName').value=''; document.getElementById('modalCat').style.display='flex'">+</button>
    </div>
    <div id="catsList" style="overflow-y:auto"></div>
  </aside>

  <section class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h2 id="current-title" style="margin:0; font-size:16px;">Inicio</h2>
      <button class="btn-main" onclick="document.getElementById('modalProd').style.display='flex'; document.getElementById('editProdId').value=''; document.getElementById('pNombre').value='';">+ Producto</button>
    </div>
    <div id="cardsGrid"></div>
  </section>
</main>

<div id="modalDetalle" class="modal" onclick="if(event.target == this) cerrarModales()">
    <div class="modal-content">
        <img id="detImg" src="">
        <h2 id="detNombre"></h2>
        <div id="detQty"></div>
        <p id="detDesc"></p>
        <button class="btn-main" style="width:100%; margin-top:10px;" onclick="cerrarModales()">Cerrar</button>
    </div>
</div>

<div id="modalCat" class="modal"><div class="modal-content">
  <h3>üìÅ Categor√≠a</h3>
  <input type="hidden" id="editCatId">
  <input type="text" id="newCatName" placeholder="NOMBRE">
  <button class="btn-main" style="width:100%" onclick="guardarCategoria()">Guardar</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px;">Cancelar</button>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
  <h3>üì¶ Producto</h3>
  <input type="hidden" id="editProdId">
  <input type="text" id="pNombre" placeholder="NOMBRE">
  <input type="number" id="pUnidades" placeholder="UNIDADES" value="1">
  <textarea id="pDesc" placeholder="DESCRIPCI√ìN"></textarea>
  <input type="file" id="pFoto" accept="image/*">
  <button class="btn-main" style="width:100%" onclick="guardarProducto()">Guardar</button>
  <button onclick="cerrarModales()" style="width:100%; background:none; border:none; margin-top:10px;">Cancelar</button>
</div></div>

</body>
</html>
